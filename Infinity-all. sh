#!/usr/bin/env bash
# ============================================================
#  Infinity-Trancendos  ‚Äì  ONE FILE TO RULE THEM ALL  (v1.0.0)
# ============================================================
#  What this script does, in order:
#    1. Creates folders + writes every project file via HERE-DOC
#    2. Optionally creates the GitHub repo with gh CLI
#    3. Adds Fly token / rclone config secrets
#    4. Commits + pushes everything
#    5. Waits for CI to turn green, then Fly deploy to finish
# ------------------------------------------------------------
set -euo pipefail
shopt -s extglob

# ---------- Configurable flags ------------------------------------------------
ORG=""                # your GitHub user/org  (required if --gh-create)
REPO="Infinity-Trancendos"
FLY_TOKEN=""          # required if you want auto-deploy
RCLONE_B64=""         # optional base64 rclone.conf
MODE="local"          # local|gh-create|dry

usage() { cat <<EOF
Usage: $0 [flags]

  --org            GitHub owner (required for --gh-create)
  --repo           Repo name   (default: Infinity-Trancendos)
  --fly-token      Fly.io API token  (or set env FLY_API_TOKEN)
  --rclone-b64     Base64 of rclone.conf  (adds GH secret)
  --gh-create      Create repo with gh CLI + push + set secrets
  --dry            Write files only (no git, no network)
EOF
exit 1; }

# ---------- Parse CLI ---------------------------------------------------------
while [[ $# -gt 0 ]]; do
  case $1 in
    --org)          ORG="$2";               shift 2;;
    --repo)         REPO="$2";              shift 2;;
    --fly-token)    FLY_TOKEN="$2";         shift 2;;
    --rclone-b64)   RCLONE_B64="$2";        shift 2;;
    --gh-create)    MODE="gh-create";       shift 1;;
    --dry)          MODE="dry";             shift 1;;
    -h|--help)      usage;;
    *) echo "Unknown flag $1"; usage;;
  esac
done

# ---------- Helpers -----------------------------------------------------------
say(){ printf "\e[36m‚ñ∂ %s\e[0m\n" "$*"; }
fail(){ printf "\e[31m‚úñ %s\e[0m\n" "$*"; exit 1; }
need(){ command -v "$1" >/dev/null || fail "$1 required"; }

ghset(){ gh secret set "$1" -b"$2" >/dev/null; }

# ---------- 0. Pre-flight -----------------------------------------------------
[[ $MODE == gh-create ]] && { need git; need gh; need curl; }
[[ -n ${FLY_TOKEN:-} ]] && export FLY_API_TOKEN="$FLY_TOKEN"

# ---------- 1. Write project tree --------------------------------------------
say "Writing project structure‚Ä¶"
mkdir -p bootstrap src/web/public .github/workflows docs

# 1A. Bootstrap installer
cat > bootstrap/unified-install.sh <<'EOS'
#!/usr/bin/env bash
set -euo pipefail
MIN_GB=2
log(){ printf "\e[36m‚ñ∂ %s\e[0m\n" "$*"; }
err(){ printf "\e[31m‚úñ %s\e[0m\n" "$*"; exit 1; }
[[ $(df -Pk . | awk 'NR==2{print int($4/1024)}') -lt $MIN_GB ]] && err "Low disk"
log "Installer stub ‚Äì replace with full logic later."
EOS
chmod +x bootstrap/unified-install.sh

# 1B. Node server
cat > src/web/server.js <<'EOS'
import express from 'express';
import path from 'node:path';
import { exec } from 'node:child_process';

const app = express();
app.use(express.static(path.join(process.cwd(), 'public')));
app.post('/api/install', (_,res)=>
  exec('bash ./bootstrap/unified-install.sh', (e,out,err)=>
    e ? res.status(500).send(err) : res.type('text').send(out)
  ));
app.listen(process.env.PORT||3000, ()=>console.log('UI live'));
EOS

# 1C. Front page
cat > src/web/public/index.html <<'EOS'
<!DOCTYPE html><meta charset="UTF-8"><title>Infinity</title>
<h2>Infinity-Trancendos Installer</h2>
<button onclick="run()">Run Installer</button>
<pre id="log"></pre>
<script>
async function run(){
  const pre=document.getElementById('log');
  pre.textContent="‚è≥ running‚Ä¶";
  const r=await fetch('/api/install',{method:'POST'});
  pre.textContent=r.ok?await r.text():'failed';
}
</script>
EOS

# 1D. CI workflow
cat > .github/workflows/lint-and-test.yml <<'EOS'
name: Lint & Test
on: [push, pull_request]
jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - run: echo "stub CI ‚Äì to be replaced with ShellCheck & ESLint"
EOS

# 1E. Deploy workflow
cat > .github/workflows/deploy.yml <<'EOS'
name: Deploy (Fly.io)
on:
  workflow_run:
    workflows: [Lint & Test]
    types: [completed]
    branches: [main]
jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: superfly/flyctl-actions@1.4
      with: { args: "deploy --remote-only" }
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
EOS

# 1F. Readme
cat > README.md <<'EOS'
# Infinity-Trancendos

Mono-script bootstrap repo generated by `infinity-all.sh`.
Replace stubs with full logic when ready.
EOS

say "‚úî  Files written."

[[ $MODE == dry ]] && exit 0

# ---------- 2. GitHub repo create / push -------------------------------------
if [[ $MODE == gh-create ]]; then
  say "Creating GitHub repo $ORG/$REPO ‚Ä¶"
  gh repo create "$ORG/$REPO" --public --confirm >/dev/null
  git init -q && git add . && git commit -m "feat: bootstrap scaffold" >/dev/null
  git branch -M main
  git remote add origin "https://github.com/$ORG/$REPO.git"
  git push -u origin main
else
  say "Skipping gh-create (MODE=$MODE)."
fi

# ---------- 3. Add secrets ----------------------------------------------------
if [[ -n ${FLY_API_TOKEN:-} ]]; then
  say "Adding FLY_API_TOKEN secret‚Ä¶"
  ghset FLY_API_TOKEN "$FLY_API_TOKEN"
fi
if [[ -n $RCLONE_B64 ]]; then
  say "Adding RCLONE_CONFIG secret‚Ä¶"
  ghset RCLONE_CONFIG "$RCLONE_B64"
fi

# ---------- 4. Wait for Actions green + deploy -------------------------------
say "Polling GitHub Actions until green‚Ä¶"
RUN_ID=$(gh run list --json databaseId -q '.[0].databaseId')
gh run watch "$RUN_ID" || fail "CI failed."

say "üéâ  Done!  Your Fly app will be at:"
echo "     https://$REPO.fly.dev    (once Fly finishes build)"